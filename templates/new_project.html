<!DOCTYPE html>
<html>
<head>
    <title>New Project</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 6px; }
        button { padding: 6px 12px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f3f3f3; }
    </style>
</head>
<body>
    <h2>New Project Form</h2>
    <form method="POST" enctype="multipart/form-data">
        <label>Quotation</label>
        <input type="text" name="quotation" required>
        
        <label>Start Date</label>
        <input type="date" name="start_date" required>

        <label>End Date</label>
        <input type="date" name="end_date" required>

        <label>Project Location</label>
        <input type="text" name="location">

        <label>Source Drawing</label>
        <input type="file" name="drawing">

        <label>Vendor</label>
        <select name="vendor_id" id="vendorSelect" required onchange="fillVendorDetails()">
            <option value="">-- Select Vendor --</option>
            {% for v in vendors %}
            <option value="{{ v.id }}" data-gst="{{ v.gst }}" data-address="{{ v.address }}">{{ v.name }}</option>
            {% endfor %}
        </select>

        <label>GST No</label>
        <input type="text" name="gst_no" id="gstField" readonly>

        <label>Address</label>
        <textarea name="address" id="addressField" readonly></textarea>

        <label>Notes</label>
        <textarea name="notes"></textarea>

        <label>Email</label>
        <input type="email" name="email">

        <label>Contact Number</label>
        <input type="text" name="contact">

        <label>Project Incharge</label>
        <input type="text" name="incharge">

        <button type="submit">Save</button>
        <a href="/dashboard"><button type="button">Back</button></a>
    </form>

    <h3>Project Table</h3>
    <table>
        <tr>
            <th>Enquiry ID</th>
            <th>Quotation</th>
            <th>Start</th>
            <th>End</th>
            <th>Location</th>
            <th>Incharge</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Notes</th>
            <th>Vendor</th>
            <th>Actions</th>
        </tr>
        {% for proj in projects %}
        <tr>
            <td>{{ proj.enquiry_id }}</td>
            <td contenteditable="true">{{ proj.quotation }}</td>
            <td contenteditable="true">{{ proj.start_date }}</td>
            <td contenteditable="true">{{ proj.end_date }}</td>
            <td contenteditable="true">{{ proj.location }}</td>
            <td contenteditable="true">{{ proj.incharge }}</td>
            <td contenteditable="true">{{ proj.contact }}</td>
            <td contenteditable="true">{{ proj.email }}</td>
            <td contenteditable="true">{{ proj.notes }}</td>
            <td>{{ proj.vendor.name }}</td>
            <td>
                <button onclick="enableEdit(this)">Edit</button>
                <button onclick="saveEdit(this, {{ proj.id }})" style="display:none;">Save</button>
                <button onclick="confirmDelete('{{ url_for('delete_project', project_id=proj.id) }}')">Delete</button>
                <button disabled>Add Measurement Sheet</button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <script>
    function fillVendorDetails() {
        const sel = document.getElementById('vendorSelect');
        const gst = sel.options[sel.selectedIndex].getAttribute('data-gst');
        const addr = sel.options[sel.selectedIndex].getAttribute('data-address');
        document.getElementById('gstField').value = gst;
        document.getElementById('addressField').value = addr;
    }

    function confirmDelete(url) {
        if (confirm('Are you sure you want to delete this project?')) {
            window.location.href = url;
        }
    }

    function enableEdit(btn) {
        const row = btn.closest('tr');
        row.querySelectorAll('[contenteditable]').forEach(td => td.contentEditable = 'true');
        btn.style.display = 'none';
        btn.nextElementSibling.style.display = 'inline-block';
    }

    function saveEdit(btn, id) {
        const row = btn.closest('tr');
        const cells = row.querySelectorAll('[contenteditable]');
        const data = {
            quotation: cells[0].innerText.trim(),
            start_date: cells[1].innerText.trim(),
            end_date: cells[2].innerText.trim(),
            location: cells[3].innerText.trim(),
            incharge: cells[4].innerText.trim(),
            contact: cells[5].innerText.trim(),
            email: cells[6].innerText.trim(),
            notes: cells[7].innerText.trim()
        };

        fetch(`/update_project/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) alert('Saved!');
            else alert('Error!');
        });

        row.querySelectorAll('[contenteditable]').forEach(td => td.contentEditable = 'false');
        btn.style.display = 'none';
        btn.previousElementSibling.style.display = 'inline-block';
    }
    </script>
</body>
</html>
